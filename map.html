<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Location Tracker</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { box-sizing: border-box; }
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow: hidden;
        }
        #container {
            display: flex;
            height: 100vh;
            width: 100vw;
        }
        #map {
            flex: 1;
            position: relative;
        }
        #sidebar {
            width: 350px;
            background: #f5f5f5;
            border-left: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        #sidebar-header {
            padding: 15px;
            background: #fff;
            border-bottom: 1px solid #ddd;
            font-weight: bold;
            font-size: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #sidebar-count {
            background: #007bff;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
        }
        #sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }
        .location-card {
            background: white;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .location-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .location-card .user-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        .location-card .timestamp {
            color: #666;
            font-size: 11px;
            margin-bottom: 8px;
        }
        .location-card .text {
            color: #333;
            font-size: 13px;
            line-height: 1.4;
            margin-bottom: 8px;
            word-wrap: break-word;
        }
        .location-card .photo-preview {
            width: 100%;
            height: 100px;
            object-fit: cover;
            border-radius: 4px;
            cursor: pointer;
        }
        .location-card .has-photo {
            color: #007bff;
            font-size: 12px;
        }
        .no-locations {
            text-align: center;
            color: #666;
            padding: 40px 20px;
        }
        .popup-content {
            max-width: 250px;
            padding: 5px;
        }
        .popup-content .user-id {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        .popup-content .timestamp {
            color: #666;
            font-size: 12px;
            margin-bottom: 8px;
        }
        .popup-content .text {
            color: #333;
            margin-bottom: 8px;
            word-wrap: break-word;
        }
        .popup-content .photo {
            margin-top: 5px;
        }
        .popup-content .photo img {
            max-width: 100%;
            border-radius: 8px;
            cursor: pointer;
        }
        @media (max-width: 768px) {
            #sidebar {
                width: 280px;
            }
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="map"></div>
        <div id="sidebar">
            <div id="sidebar-header">
                <span>üìç Lokality na mapƒõ</span>
                <span id="sidebar-count">0</span>
            </div>
            <div id="sidebar-content">
                <div class="no-locations">Naƒç√≠t√°n√≠...</div>
            </div>
        </div>
    </div>

    <script>
        const supabaseClient = supabase.createClient(
            'https://woqcaafmlzkojbyqoncg.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndvcWNhYWZtbHprb2pieXFvbmNnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg5MTQzMzgsImV4cCI6MjA4NDQ5MDMzOH0.A6W8mMhtRQYPXl3iUB6UK9O0m3yFtmndM2gheP0c77Q'
        );

        const map = new maplibregl.Map({
            container: 'map',
            style: {
                version: 8,
                sources: {
                    osm: {
                        type: 'raster',
                        tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'],
                        tileSize: 256,
                        attribution: '&copy; OpenStreetMap Contributors',
                        maxzoom: 19
                    }
                },
                layers: [{
                    id: 'osm',
                    type: 'raster',
                    source: 'osm'
                }]
            },
        });

        let markers = {};
        let allLocations = [];

        // Helper function to build popup HTML
        function buildPopupHTML(loc) {
            let html = '<div class="popup-content">';
            const displayName = loc.display_name || `User: ${loc.user_id}`;
            html += `<div class="user-id">${escapeHtml(displayName)}</div>`;
            html += `<div class="timestamp">${new Date(loc.created_at).toLocaleString()}</div>`;

            if (loc.text) {
                html += `<div class="text">${escapeHtml(loc.text)}</div>`;
            }

            if (loc.photo_url) {
                html += `<div class="photo"><a href="${escapeHtml(loc.photo_url)}" target="_blank"><img src="${escapeHtml(loc.photo_url)}" alt="Photo"></a></div>`;
            }

            html += '</div>';
            return html;
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Check if location is within current map bounds
        function isLocationVisible(loc) {
            const bounds = map.getBounds();
            return loc.longitude >= bounds.getWest() &&
                   loc.longitude <= bounds.getEast() &&
                   loc.latitude >= bounds.getSouth() &&
                   loc.latitude <= bounds.getNorth();
        }

        // Build sidebar card HTML
        function buildCardHTML(loc) {
            const displayName = loc.display_name || `User: ${loc.user_id}`;
            const date = new Date(loc.created_at).toLocaleString('cs-CZ');

            let html = `<div class="location-card" data-id="${loc.id}">`;
            html += `<div class="user-name">${escapeHtml(displayName)}</div>`;
            html += `<div class="timestamp">${date}</div>`;

            if (loc.text) {
                const shortText = loc.text.length > 100 ? loc.text.substring(0, 100) + '...' : loc.text;
                html += `<div class="text">${escapeHtml(shortText)}</div>`;
            }

            if (loc.photo_url) {
                html += `<img class="photo-preview" src="${escapeHtml(loc.photo_url)}" alt="Photo" onclick="window.open('${escapeHtml(loc.photo_url)}', '_blank')">`;
            }

            html += '</div>';
            return html;
        }

        // Update sidebar with visible locations
        function updateSidebar() {
            const visibleLocations = allLocations.filter(isLocationVisible);
            const sidebarContent = document.getElementById('sidebar-content');
            const sidebarCount = document.getElementById('sidebar-count');

            sidebarCount.textContent = visibleLocations.length;

            if (visibleLocations.length === 0) {
                sidebarContent.innerHTML = '<div class="no-locations">Na aktu√°ln√≠m zobrazen√≠ mapy nejsou ≈æ√°dn√© lokality.<br><br>P≈ôibli≈æte nebo posu≈àte mapu.</div>';
                return;
            }

            // Sort by newest first
            visibleLocations.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

            sidebarContent.innerHTML = visibleLocations.map(buildCardHTML).join('');

            // Add click handlers to cards
            sidebarContent.querySelectorAll('.location-card').forEach(card => {
                card.addEventListener('click', () => {
                    const locId = card.getAttribute('data-id');
                    const marker = markers[locId];
                    if (marker) {
                        marker.togglePopup();
                        map.flyTo({ center: marker.getLngLat(), zoom: 16 });
                    }
                });
            });
        }

        async function loadLocations() {
            const { data } = await supabaseClient.from('locations').select('*').order('created_at', { ascending: false });

            if (data) {
                allLocations = data;

                data.forEach(loc => {
                    if (!markers[loc.id]) {
                        const marker = new maplibregl.Marker()
                            .setLngLat([loc.longitude, loc.latitude])
                            .setPopup(new maplibregl.Popup().setHTML(buildPopupHTML(loc)))
                            .addTo(map);
                        markers[loc.id] = marker;
                    }
                });

                if (data.length > 0) {
                    map.flyTo({ center: [data[0].longitude, data[0].latitude], zoom: 14 });
                }

                updateSidebar();
            }
        }

        // Realtime updates
        supabaseClient.channel('locations')
            .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'locations' }, (payload) => {
                const loc = payload.new;
                allLocations.unshift(loc);

                const marker = new maplibregl.Marker()
                    .setLngLat([loc.longitude, loc.latitude])
                    .setPopup(new maplibregl.Popup().setHTML(buildPopupHTML(loc)))
                    .addTo(map);
                markers[loc.id] = marker;

                map.flyTo({ center: [loc.longitude, loc.latitude], zoom: 14 });
                updateSidebar();
            })
            .on('postgres_changes', { event: 'DELETE', schema: 'public', table: 'locations' }, (payload) => {
                const locId = payload.old.id;
                if (markers[locId]) {
                    markers[locId].remove();
                    delete markers[locId];
                }
                allLocations = allLocations.filter(l => l.id !== locId);
                updateSidebar();
            })
            .subscribe();

        // Update sidebar when map moves or zooms
        map.on('moveend', updateSidebar);
        map.on('zoomend', updateSidebar);

        map.on('load', loadLocations);
    </script>
</body>
</html>
